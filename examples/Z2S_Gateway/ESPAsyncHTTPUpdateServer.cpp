#include <Arduino.h>
#include "StreamString.h"
#include "ESPAsyncHTTPUpdateServer.h"
#include <Ticker.h>

#ifdef ESP32
    #ifdef ESPASYNCHTTPUPDATESERVER_LITTLEFS
        #include <LittleFS.h>
    #else
        #include <SPIFFS.h>
    #endif
    #include <Update.h>
#elif defined(ESP8266)
    #include <flash_hal.h>
    #include <FS.h>
#else
  #error "This library only supports boards with an ESP8266 or ESP32 processor."
#endif

#ifndef ESPASYNCHTTPUPDATESERVER_SerialOutput
    #define ESPASYNCHTTPUPDATESERVER_SerialOutput Serial
#endif

#ifdef ESPASYNCHTTPUPDATESERVER_DEBUG
    #define Log(...) ESPASYNCHTTPUPDATESERVER_SerialOutput.printf(__VA_ARGS__)
#else
    #define Log(...) 
#endif

#ifndef ESPASYNCHTTPUPDATESERVER_MODE
    #define ESPASYNCHTTPUPDATESERVER_MODE 1
#endif

#define ESPASYNCHTTPUPDATESERVER_PRETTY 1

//generated code start
#if ESPASYNCHTTPUPDATESERVER_MODE == 0
    #ifdef ESPASYNCHTTPUPDATESERVER_PRETTY
        static const uint8_t serverIndex[] PROGMEM = { 31,139,8,0,106,81,113,105,2,255,157,146,205,110,212,48,16,199,95,197,236,170,82,139,214,221,108,182,133,214,249,64,92,184,22,169,229,132,16,114,236,73,50,224,216,145,237,236,71,87,251,6,28,56,113,230,217,250,36,56,217,13,106,145,64,168,135,140,20,219,243,255,205,127,102,210,23,210,8,191,109,161,246,141,202,211,62,18,197,117,149,129,206,211,6,60,39,162,230,214,129,207,58,95,210,171,241,204,104,15,218,103,147,53,74,95,103,18,86,40,128,14,63,51,212,232,145,43,234,4,87,144,45,38,68,243,6,178,21,194,186,53,214,231,169,243,91,5,249,203,93,25,52,104,201,27,84,91,214,24,109,92,203,5,36,133,177,18,44,181,92,98,231,216,34,106,55,251,58,222,53,220,86,168,169,55,45,139,246,245,98,39,140,50,150,77,1,56,8,158,12,74,14,239,129,93,245,239,11,35,183,187,130,139,175,149,53,157,150,108,26,199,113,82,241,150,45,195,109,114,144,98,81,82,3,86,181,15,136,104,85,239,75,99,155,81,245,85,177,188,188,40,147,71,10,10,53,112,75,171,190,170,96,251,52,126,29,73,168,102,71,62,137,102,211,235,139,162,128,107,18,196,78,206,146,150,75,137,186,26,120,123,212,109,231,119,7,91,44,110,55,196,25,133,146,252,166,152,13,117,53,151,102,205,34,210,219,61,132,254,225,52,138,162,229,88,230,242,114,212,98,172,68,5,212,129,2,225,141,165,69,231,189,209,179,225,238,99,63,201,204,117,69,131,254,211,147,30,28,113,71,139,101,89,62,242,127,146,252,107,22,161,227,231,98,39,209,181,138,111,89,169,96,147,244,129,74,180,161,0,52,154,5,209,174,209,201,151,206,121,44,183,244,184,28,76,132,0,54,225,10,43,77,209,67,227,142,71,251,116,126,88,130,180,31,21,17,138,59,151,137,176,124,139,252,244,225,219,247,135,31,63,63,135,239,140,220,220,189,77,231,225,48,237,167,67,248,0,203,38,111,134,125,42,209,54,107,110,97,50,166,19,208,195,30,103,77,167,60,182,220,250,121,159,70,37,15,251,26,150,182,54,50,123,127,115,123,23,48,113,254,238,152,29,228,227,60,149,184,202,211,161,127,100,80,232,251,27,112,2,90,159,157,23,168,103,125,56,175,238,201,19,242,147,148,67,203,201,138,171,14,178,201,135,54,80,129,140,148,73,158,206,7,198,80,209,95,236,40,112,91,23,154,244,92,67,10,110,135,252,231,89,26,233,255,99,106,36,253,97,235,23,4,247,158,198,74,4,0,0 };
    #else
        static const uint8_t serverIndex[] PROGMEM = { 31,139,8,0,106,81,113,105,2,255,149,142,203,106,196,48,12,69,127,197,245,122,50,165,187,82,44,119,215,237,20,166,253,0,197,81,38,2,191,112,148,132,233,215,55,49,77,97,22,133,206,70,160,199,213,57,230,161,75,78,174,153,6,9,222,154,173,42,143,241,2,20,173,9,36,168,220,128,101,36,129,73,250,230,121,159,165,40,20,5,244,194,157,12,208,209,204,142,154,218,28,56,178,48,250,102,116,232,9,158,180,138,24,8,102,166,37,167,34,214,244,169,4,133,78,56,69,208,175,117,217,115,9,11,22,210,138,98,149,129,48,121,225,140,69,30,183,243,166,195,21,186,146,135,212,193,251,233,252,97,223,126,18,47,166,45,214,112,204,147,168,26,236,217,211,250,221,81,22,56,182,28,15,91,57,94,190,212,13,232,38,50,78,109,96,81,51,250,137,64,127,230,21,70,106,7,104,107,170,194,31,222,158,198,235,40,20,238,49,247,116,174,153,187,221,119,216,127,236,119,200,175,255,55,187,114,189,153,233,1,0,0 };
    #endif
#elif ESPASYNCHTTPUPDATESERVER_MODE == 1
    #ifdef ESPASYNCHTTPUPDATESERVER_PRETTY
        static const uint8_t serverIndex[] PROGMEM = { 31,139,8,0,106,81,113,105,2,255,165,87,109,143,219,184,17,254,43,170,131,34,119,5,165,21,245,46,217,114,155,110,123,119,69,123,77,128,36,31,138,162,31,104,137,182,212,232,173,18,237,221,205,194,255,189,207,140,228,93,239,94,80,28,80,24,178,68,145,156,121,158,153,135,67,106,243,155,63,189,191,253,244,143,15,127,182,42,211,54,219,13,253,91,141,234,14,249,64,45,173,202,237,166,213,70,89,69,165,198,73,155,252,243,167,31,236,100,121,215,169,86,231,167,90,223,13,253,104,172,162,239,140,238,76,190,186,171,75,83,229,165,62,213,133,182,185,33,234,174,54,181,106,236,169,80,141,206,165,104,213,125,221,30,219,167,246,113,210,35,55,212,14,237,174,95,109,55,166,54,141,222,254,80,143,237,157,26,181,245,121,40,149,209,155,155,249,245,102,50,15,184,253,78,100,217,78,239,251,81,227,65,237,141,30,31,119,253,189,61,213,95,235,238,144,237,250,177,132,89,188,57,19,173,108,223,23,199,9,128,76,85,119,143,83,49,246,77,99,239,116,165,78,117,63,102,83,219,247,166,58,239,250,242,65,208,104,81,73,81,249,98,120,108,213,120,168,187,204,93,15,170,44,201,172,187,222,131,169,189,87,109,221,60,100,63,233,230,164,77,93,168,191,235,163,22,171,167,166,69,237,149,120,106,139,119,35,2,32,38,213,77,54,200,214,123,118,245,184,83,197,151,195,216,31,187,50,123,227,186,165,12,229,186,173,59,187,210,245,161,50,153,116,221,83,181,46,235,105,104,212,67,182,111,244,253,154,254,236,178,30,117,97,234,190,203,138,190,57,182,221,250,223,199,201,212,251,7,123,201,1,15,181,39,163,70,179,86,77,125,232,236,218,232,118,202,10,244,233,113,198,143,32,233,76,6,195,253,220,188,155,61,6,174,187,134,77,4,228,205,126,191,191,112,182,77,63,100,81,56,220,159,157,187,81,13,3,226,204,121,37,128,191,93,35,153,115,154,179,208,117,97,239,18,40,15,13,75,186,52,11,57,120,65,149,108,47,233,25,85,89,31,167,76,190,158,185,230,76,86,170,236,239,50,215,130,111,43,194,53,30,118,234,59,87,240,207,241,191,95,207,217,65,142,141,233,91,158,119,174,228,227,53,35,223,117,175,8,123,62,44,127,99,18,33,180,42,127,201,54,243,117,95,141,147,225,171,88,125,195,178,209,247,198,230,136,103,141,222,155,75,40,93,215,61,215,221,112,52,255,52,15,131,206,223,238,235,70,191,253,215,117,12,175,82,162,219,215,142,103,128,166,179,41,124,195,227,175,208,195,65,13,243,180,221,17,38,186,87,50,115,215,87,158,231,52,128,237,255,200,135,244,46,220,204,8,1,99,193,181,217,145,100,80,168,73,95,235,229,138,134,227,131,72,113,28,39,244,149,122,175,142,141,121,177,112,234,174,194,50,48,191,42,205,11,141,172,234,79,180,196,95,146,249,63,35,123,149,163,245,179,101,251,153,212,25,69,73,55,79,81,223,53,125,241,229,133,14,160,250,87,118,163,107,179,88,212,238,217,33,96,246,216,223,189,204,222,55,22,231,37,117,223,20,193,197,138,53,99,122,170,77,51,95,47,116,95,59,126,13,244,202,196,55,194,198,98,66,0,238,50,185,190,216,62,191,105,250,67,255,138,254,165,211,82,71,211,91,188,50,46,37,43,164,198,140,135,58,215,191,172,112,231,63,180,186,172,149,133,18,172,117,103,169,174,180,190,187,170,33,62,72,124,255,248,84,104,94,84,147,232,116,119,62,111,110,230,234,191,185,153,247,39,42,164,219,77,89,159,172,162,81,211,148,47,51,177,73,156,14,86,93,230,132,223,130,112,38,44,144,92,58,210,162,45,11,178,203,87,174,229,90,158,203,215,202,186,207,93,235,30,219,196,52,168,66,231,195,168,81,166,79,218,122,200,221,237,102,80,166,178,202,124,245,115,152,58,190,240,156,176,144,137,35,161,205,72,248,210,73,68,34,2,215,241,132,231,163,199,71,71,232,196,34,192,72,41,157,20,15,82,96,184,95,216,46,158,124,39,194,61,22,177,35,109,234,149,48,66,61,30,172,197,60,66,46,150,37,185,241,96,61,198,112,47,116,66,33,67,39,16,126,66,16,252,194,163,201,232,9,49,194,199,251,132,159,253,226,50,57,226,59,176,146,209,34,192,29,174,69,234,36,118,72,200,0,17,15,1,121,224,17,194,35,131,49,46,184,242,132,76,11,66,151,58,158,205,142,232,65,18,85,112,76,11,59,129,67,50,41,35,38,24,218,140,15,44,136,10,209,240,109,73,164,64,145,94,131,123,128,185,129,147,218,41,96,18,8,25,16,161,128,200,19,158,144,102,48,112,154,15,116,240,137,46,242,136,139,161,251,51,98,65,168,57,132,46,135,18,83,80,38,192,183,152,7,5,28,145,24,214,35,226,225,1,211,28,239,24,76,240,34,0,248,132,18,18,194,188,7,215,9,204,248,192,136,185,136,81,72,48,224,0,129,103,150,228,68,82,6,104,24,98,148,192,90,58,187,165,12,162,63,177,193,218,179,225,13,36,3,178,25,160,129,89,9,145,139,136,88,76,77,15,8,252,144,38,165,118,136,6,103,125,9,23,188,130,107,128,167,148,81,133,172,6,143,196,226,17,60,127,65,149,204,150,145,18,196,136,98,136,244,16,15,50,64,161,150,52,107,78,28,147,138,111,125,50,150,80,150,136,61,38,136,208,39,61,193,255,179,224,66,22,160,199,112,188,219,144,186,17,198,132,223,133,226,34,250,175,214,207,113,68,214,100,65,117,89,46,151,191,220,163,130,68,23,113,32,57,240,17,220,197,20,233,180,224,100,207,81,76,133,207,90,246,41,235,62,103,135,180,159,46,178,149,139,116,211,34,164,96,146,165,25,103,194,154,229,68,83,3,225,16,146,103,250,204,154,194,131,16,120,28,28,18,51,107,50,22,62,20,97,99,205,16,221,144,243,230,146,93,225,218,114,214,94,100,67,244,8,171,36,49,83,22,124,219,3,220,101,56,57,66,240,29,57,39,137,166,164,104,4,36,82,148,0,52,48,60,38,183,1,229,154,148,138,97,244,135,68,184,179,168,195,203,162,8,22,67,100,144,113,80,230,124,22,184,71,80,49,43,224,181,32,105,189,112,182,200,27,180,27,80,174,105,225,196,183,49,45,185,132,104,227,41,120,122,162,180,32,65,9,39,154,66,36,237,121,101,7,246,28,200,16,114,150,183,9,213,14,50,73,246,121,245,70,84,68,16,218,4,96,92,18,32,11,151,20,64,1,244,201,231,188,222,105,237,250,20,217,128,23,18,132,21,20,96,76,82,163,250,32,105,53,123,84,15,3,174,123,183,49,106,134,136,80,231,4,64,133,180,162,23,112,128,41,93,143,171,98,194,80,35,241,44,67,201,158,169,146,164,28,240,128,176,113,24,83,50,11,241,167,84,101,104,85,132,92,78,2,155,180,46,35,94,175,17,65,165,136,82,66,200,51,209,33,49,163,63,186,77,72,209,50,241,105,125,4,244,146,252,139,43,44,132,44,98,153,206,229,1,42,241,102,157,219,254,172,117,164,159,229,198,92,37,23,7,119,46,39,17,87,100,10,136,100,212,44,76,170,168,73,17,115,50,120,59,144,156,80,70,12,248,183,50,33,94,41,186,98,42,144,228,86,60,35,248,138,239,160,27,218,123,112,195,102,182,221,208,201,203,82,124,212,203,87,191,231,239,175,253,242,133,180,90,118,191,194,210,93,193,187,122,139,35,87,61,224,27,224,134,166,217,248,126,82,22,190,219,170,190,204,63,188,255,248,9,159,119,114,251,241,243,135,191,189,195,70,42,175,55,80,236,141,232,244,127,249,241,133,119,87,195,46,39,137,237,134,79,35,22,188,60,161,217,126,212,13,142,164,22,141,217,220,112,255,118,195,39,14,139,177,209,123,16,41,244,96,114,103,87,119,130,254,156,195,87,235,5,39,107,212,255,57,226,108,139,77,254,6,126,47,255,87,72,47,135,98,156,2,248,136,56,91,159,142,187,182,54,219,11,236,185,235,229,144,229,185,239,138,166,46,190,208,71,107,135,35,168,131,211,141,162,232,58,213,168,247,249,219,155,183,171,237,31,223,221,254,213,250,244,222,250,241,243,95,158,77,45,112,40,176,79,141,249,28,114,195,31,210,255,5,96,120,152,217,88,15,0,0 };
    #else
        static const uint8_t serverIndex[] PROGMEM = { 31,139,8,0,106,81,113,105,2,255,85,142,205,78,196,48,12,132,95,37,228,188,93,196,109,133,226,112,227,10,18,203,3,184,137,187,181,148,63,165,78,43,120,122,218,136,61,236,101,36,123,60,254,198,60,249,236,228,167,208,44,49,88,115,168,10,152,110,64,201,154,72,130,202,205,88,23,18,104,50,13,151,251,46,39,161,36,160,55,246,50,131,167,149,29,13,125,56,113,98,97,12,195,226,48,16,188,104,149,48,18,172,76,91,201,85,172,153,114,141,10,157,112,78,160,223,186,57,113,141,27,86,210,138,82,47,3,177,5,225,130,85,158,143,243,193,227,14,221,201,115,246,240,249,241,117,181,239,255,137,87,51,86,107,56,149,38,170,7,39,14,180,127,119,84,4,206,35,167,211,33,231,219,175,122,0,61,68,150,54,70,22,181,98,104,4,250,187,236,48,82,119,128,182,166,87,176,127,120,226,68,109,41,1,0,0 };
    #endif
#elif ESPASYNCHTTPUPDATESERVER_MODE == 2
    #ifdef ESPASYNCHTTPUPDATESERVER_PRETTY
        static const uint8_t serverIndex[] PROGMEM = { 31,139,8,0,106,81,113,105,2,255,165,87,109,143,219,184,17,254,43,234,6,69,238,10,74,22,245,46,217,50,26,108,47,215,3,122,73,208,36,31,138,162,31,104,137,182,212,232,173,146,108,239,102,225,255,222,103,134,246,174,119,111,81,28,80,24,178,68,145,156,121,230,153,135,67,106,245,135,191,124,188,253,242,143,79,63,89,213,220,54,235,21,253,91,141,234,118,249,64,45,173,202,245,170,213,179,178,138,74,141,147,158,243,175,95,222,219,201,249,93,167,90,157,31,106,125,28,250,113,182,138,190,155,117,55,231,55,199,186,156,171,188,212,135,186,208,54,55,68,221,213,115,173,26,123,42,84,163,115,41,90,117,87,183,251,246,177,189,159,244,200,13,181,65,187,235,111,214,171,185,158,27,189,126,95,143,237,81,141,218,250,58,148,106,214,171,133,121,189,154,230,123,220,254,36,178,108,163,183,253,168,241,160,182,179,30,31,54,253,157,61,213,223,235,110,151,109,250,177,132,89,188,57,81,88,217,182,47,246,19,0,205,85,221,61,76,197,216,55,141,189,209,149,58,212,253,152,77,109,223,207,213,105,211,151,247,130,70,139,74,138,202,23,195,67,171,198,93,221,101,238,114,80,101,73,102,221,229,22,145,218,91,213,214,205,125,246,87,221,28,244,92,23,234,131,222,107,113,243,216,180,168,125,35,30,219,226,221,8,2,196,164,186,201,70,176,245,150,93,61,108,84,241,109,55,246,251,174,204,222,184,110,41,67,185,108,235,206,174,116,189,171,230,76,186,238,161,90,150,245,52,52,234,62,219,54,250,110,73,127,118,89,143,186,152,235,190,203,138,190,217,183,221,242,223,251,105,174,183,247,246,57,7,60,212,158,102,53,206,75,213,212,187,206,174,103,221,78,89,129,62,61,26,252,32,73,103,50,24,238,76,243,104,60,6,174,187,132,77,16,242,102,187,221,94,98,182,231,126,200,162,112,184,59,57,199,81,13,3,120,230,188,18,192,63,46,145,76,147,230,44,116,93,216,187,16,229,161,97,73,151,102,33,7,207,66,37,219,231,244,140,170,172,247,83,38,95,206,92,114,38,43,85,246,199,204,181,224,219,138,112,141,187,141,250,193,21,252,115,252,31,151,38,59,200,241,60,247,45,207,59,85,242,225,58,34,223,117,175,2,246,124,88,126,101,18,33,180,42,255,156,109,142,215,125,49,78,134,47,184,122,197,242,172,239,102,155,25,207,26,189,157,47,84,186,174,123,170,187,97,63,255,115,190,31,116,254,118,91,55,250,237,191,174,57,188,74,137,110,95,58,54,0,231,206,38,250,134,135,223,161,135,157,26,204,180,205,30,38,186,23,50,115,151,87,158,77,26,16,237,255,200,135,244,46,177,205,35,4,140,5,215,102,123,146,65,161,38,125,173,151,171,48,28,31,129,20,251,113,66,95,169,183,106,223,204,207,22,78,221,85,88,6,243,239,74,243,57,140,172,234,15,180,196,159,7,243,127,50,123,149,163,229,147,101,251,41,168,19,138,146,110,30,89,223,52,125,241,237,153,14,160,250,23,118,163,107,179,88,212,238,201,33,96,246,216,31,159,103,239,149,197,121,73,221,171,34,184,88,177,12,166,199,218,100,226,245,66,247,165,227,151,64,175,76,188,66,27,139,9,4,28,51,185,188,216,62,189,105,250,93,255,34,252,75,167,165,246,115,111,241,202,184,148,172,144,26,6,15,117,46,127,91,225,78,127,110,117,89,43,11,37,88,235,206,82,93,105,253,112,85,67,124,4,241,227,195,99,161,121,86,77,162,195,241,116,90,45,76,245,95,45,204,254,68,133,116,189,42,235,131,85,52,106,154,242,243,76,108,18,135,157,85,151,57,225,183,32,156,9,11,36,151,142,180,104,203,130,236,242,27,215,114,45,207,229,235,198,186,203,93,235,14,219,196,52,168,66,231,195,168,81,166,15,218,186,207,221,245,106,80,115,101,149,249,205,175,97,234,248,194,115,194,66,38,142,132,54,35,225,75,39,17,137,8,92,199,19,158,143,30,31,29,161,19,139,0,35,165,116,82,60,72,129,225,126,97,187,120,242,157,8,247,88,196,142,180,169,87,194,8,245,120,176,22,243,8,121,182,44,201,141,7,235,49,134,123,161,19,10,25,58,129,240,19,130,224,23,30,77,70,79,136,17,62,222,39,252,236,23,151,201,17,223,129,149,140,22,1,238,112,45,82,39,177,67,66,6,136,120,8,200,3,143,16,30,25,140,113,193,149,39,100,90,16,186,212,241,108,118,68,15,146,66,69,140,105,97,39,112,72,38,101,196,1,134,54,227,67,20,20,10,133,225,219,146,130,66,136,244,26,177,7,152,27,56,169,157,2,38,129,144,1,5,20,80,240,132,39,164,25,12,156,230,3,29,124,162,139,60,226,98,232,190,65,44,8,53,83,232,50,149,152,130,50,129,120,11,51,40,96,70,98,88,143,40,14,15,152,12,223,49,34,193,139,0,224,19,74,72,8,243,30,92,39,48,227,3,35,230,130,163,144,96,192,1,136,231,40,201,137,164,12,208,48,112,148,192,90,106,220,82,6,209,159,216,136,218,179,225,13,65,6,100,51,64,3,179,18,10,46,162,192,98,106,122,64,224,135,52,41,181,67,52,56,235,103,186,224,21,177,6,120,74,25,85,200,106,240,72,44,30,193,243,207,168,18,99,25,41,1,71,196,33,210,67,113,144,1,162,90,210,44,147,56,14,42,190,245,201,88,66,89,162,232,49,65,132,62,233,9,254,159,4,23,178,0,61,134,227,221,134,212,13,26,19,126,23,138,139,232,191,91,191,198,17,89,147,5,213,101,121,190,252,243,61,42,72,116,17,19,201,196,71,112,23,19,211,105,193,201,54,44,166,194,103,45,251,148,117,159,179,67,218,79,207,178,149,103,233,166,69,72,100,146,37,131,51,97,205,114,162,169,1,58,132,228,153,62,71,77,244,128,2,143,201,33,49,179,38,99,225,67,17,54,214,12,133,27,114,222,92,178,43,92,91,26,237,69,54,68,15,90,37,137,153,178,224,219,30,224,158,135,147,35,144,239,72,147,36,154,146,162,17,144,72,81,2,208,192,240,152,220,6,148,107,82,42,134,209,31,18,225,26,81,135,151,69,17,156,13,145,65,198,65,153,243,89,224,30,65,197,172,128,215,130,164,245,194,217,34,111,208,110,64,185,166,133,19,223,198,180,228,18,10,27,79,193,227,19,165,5,9,74,56,209,68,145,180,205,202,14,108,67,100,8,57,203,219,132,106,7,153,36,251,188,122,35,42,34,160,54,1,24,151,4,200,194,37,5,16,129,62,249,52,235,157,214,174,79,204,6,188,144,32,172,160,64,196,36,53,170,15,146,86,179,71,245,48,224,186,119,27,163,102,136,8,117,78,0,84,72,43,250,12,14,48,165,235,113,85,76,24,106,36,158,100,40,217,51,85,146,148,9,15,8,27,211,152,146,89,136,63,165,42,67,171,34,228,114,18,216,164,117,25,241,122,141,8,42,49,74,9,33,207,20,14,137,25,253,209,109,66,138,150,137,79,235,35,160,151,228,95,92,97,33,100,17,203,212,148,7,168,196,51,58,183,125,163,117,164,159,229,198,177,74,46,14,174,41,39,17,87,100,34,68,50,106,22,38,85,212,164,136,57,25,188,29,72,78,40,35,6,252,91,153,80,92,41,186,98,42,144,228,86,60,33,248,142,239,160,5,237,61,184,97,51,91,175,232,228,69,91,218,158,191,134,222,83,11,95,98,85,95,230,159,62,126,254,98,41,62,4,230,11,211,109,233,174,224,237,189,197,217,171,30,240,49,176,160,249,54,250,20,190,237,228,250,243,215,79,127,123,135,93,84,94,239,158,216,24,209,233,255,246,203,11,239,174,134,93,142,17,235,21,31,69,44,88,198,59,51,101,253,89,55,56,143,90,52,102,181,224,254,245,138,143,27,22,227,161,247,192,90,232,97,206,157,77,221,9,250,115,118,223,205,7,229,197,138,53,234,255,236,113,176,197,14,191,128,223,203,255,21,210,203,137,24,71,0,62,31,26,235,211,126,211,214,243,250,2,219,116,61,31,114,126,238,187,162,169,139,111,244,197,218,225,252,233,224,104,163,136,64,167,26,245,54,127,187,120,123,179,190,253,248,225,253,47,63,127,253,251,187,47,191,124,252,96,125,122,247,243,79,79,22,207,168,136,211,199,134,57,139,44,248,99,250,191,224,113,10,252,92,15,0,0 };
    #else
        static const uint8_t serverIndex[] PROGMEM = { 31,139,8,0,106,81,113,105,2,255,93,142,203,106,3,49,12,69,127,197,245,58,147,210,93,41,150,187,235,54,133,52,31,224,177,53,25,129,95,216,242,132,228,235,235,49,148,210,110,46,72,226,232,92,245,228,146,229,123,198,149,131,215,106,79,225,77,188,2,70,173,2,178,17,118,53,165,34,67,227,101,122,253,217,165,200,24,25,228,141,28,175,224,112,35,139,211,24,14,20,137,201,248,169,90,227,17,94,164,136,38,32,108,132,183,156,10,107,181,164,18,132,177,76,41,130,124,31,199,133,60,214,123,101,12,82,96,28,117,32,52,207,148,77,225,231,29,152,156,233,218,238,94,147,131,207,211,249,75,127,116,230,60,152,55,53,23,173,40,230,198,98,160,251,187,110,176,152,25,142,51,197,195,30,199,235,67,252,147,253,129,106,155,3,177,216,140,111,8,242,146,187,16,197,175,68,106,53,138,232,111,211,36,186,13,49,1,0,0 };
    #endif
#endif
//generated code end

static const char successResponse[] PROGMEM =
    R"(<meta content="15;URL=/"http-equiv=refresh>Update Success! Rebooting...)";

Ticker restartTimer;

ESPAsyncHTTPUpdateServer::ESPAsyncHTTPUpdateServer()
{
    _server = NULL;
    _username = emptyString;
    _password = emptyString;
    _authenticated = false;
}

void ESPAsyncHTTPUpdateServer::setup(AsyncWebServer *server, const String &path, const String &username, const String &password)
{
    _server = server;
    _username = username;
    _password = password;

    // handler for the /update form page
    _server->on(path.c_str(), HTTP_GET, [&](AsyncWebServerRequest *request)
                {
            if(_username != emptyString && _password != emptyString)
                if( !request->authenticate(_username.c_str(), _password.c_str()))
                    return request->requestAuthentication();
#ifdef ESP32
            AsyncWebServerResponse* response = request->beginResponse(200, "text/html", serverIndex, sizeof(serverIndex));
#else
            AsyncWebServerResponse* response = request->beginResponse_P(200, "text/html", serverIndex, sizeof(serverIndex));
#endif
            response->addHeader("Content-Encoding", "gzip");
            request->send(response); });

    // handler for the /update form page - preflight options
    _server->on(path.c_str(), HTTP_OPTIONS, [&](AsyncWebServerRequest *request)
                {
            AsyncWebServerResponse* response = request->beginResponse(200,F("text/html"), String(F("y")));
            response->addHeader("Access-Control-Allow-Headers", "*");
            response->addHeader("Access-Control-Allow-Origin", "*");
            request->send(response); 
            
            _authenticated = (_username == emptyString || _password == emptyString || request -> authenticate(_username.c_str(), _password.c_str()));
            if (!_authenticated)
            {
                Log("Unauthenticated Update\n");
                return;
            } });

    // handler for the /update form POST (once file upload finishes)
    _server->on(
        path.c_str(), HTTP_POST, [&](AsyncWebServerRequest *request)
        {
        // if requestAuthentication() is false second handler will run, else it wont.
        if (!_authenticated)
            return request->requestAuthentication();

        if (_updateResult != UpdateResult::UPDATE_OK)
        {
            AsyncWebServerResponse *response = request->beginResponse(200, F("text/html"), Update.hasError() ? String(F("Update error: ")) + _updaterError : "Update aborted by server.");
            response->addHeader("Access-Control-Allow-Headers", "*");
            response->addHeader("Access-Control-Allow-Origin", "*");
            response->addHeader("Connection", "close");
            request->send(response);
        }
        else
        {
#ifdef ESP32
            request->send(200, PSTR("text/html"), successResponse);
#else
            request->send_P(200, PSTR("text/html"), successResponse);
#endif
            Log("Rebooting...\n");
            restartTimer.once_ms(1000,[]{ ESP.restart(); });
        } },
        [&](AsyncWebServerRequest *request, String filename, size_t index, uint8_t *data, size_t len, bool final)
        {
            // handler for the file upload, gets the sketch bytes, and writes
            // them through the Update object

            _updateType = request->getParam("name")->value() == "filesystem"?
                    UpdateType::FILE_SYSTEM :
                    UpdateType::FIRMWARE;

            if (!index)
            {
                _updaterError.clear();

#ifdef ESPASYNCHTTPUPDATESERVER_DEBUG
                ESPASYNCHTTPUPDATESERVER_SerialOutput.setDebugOutput(true);
#endif
                _authenticated = (_username == emptyString || _password == emptyString || request->authenticate(_username.c_str(), _password.c_str()));
                if (!_authenticated)
                {
                    Log("Unauthenticated Update\n");
                    return;
                }

                if (onUpdateBegin)
                {
                    _updateResult = UpdateResult::UPDATE_OK;
                    onUpdateBegin(_updateType, _updateResult);
                    if (_updateResult != UpdateResult::UPDATE_OK)
                    {
                        Log("Update aborted by server: %d\n", _updateResult);
                        if(onUpdateEnd)
                            onUpdateEnd(_updateType, _updateResult);
                        return;
                    }
                }

                Log("Update: %s\n", filename.c_str());
#ifdef ESP8266
                Update.runAsync(true);
#endif
                if (_updateType == UpdateType::FILE_SYSTEM)
                {
                    Log("updating filesystem\n");
#ifdef ESP8266
                    int command = U_FS;
                    size_t fsSize = ((size_t)FS_end - (size_t)FS_start);
                    close_all_fs();
#elif defined(ESP32)
                    int command = U_SPIFFS;
    #ifdef ESPASYNCHTTPUPDATESERVER_LITTLEFS
                    size_t fsSize = LittleFS.totalBytes();
    #else
                    size_t fsSize = SPIFFS.totalBytes();
    #endif
#endif
                    if (!Update.begin(fsSize, command))
                    { // start with max available size
#ifdef ESPASYNCHTTPUPDATESERVER_DEBUG
                        Update.printError(ESPASYNCHTTPUPDATESERVER_SerialOutput);
#endif
                    }
                }
                else
                {
                    Log("updating flash\n");
                    uint32_t maxSketchSpace = (ESP.getFreeSketchSpace() - 0x1000) & 0xFFFFF000;
                    if (!Update.begin(maxSketchSpace, U_FLASH)) // start with max available size
                        _setUpdaterError();
                }
            }

            if (_authenticated && len && _updateResult == UpdateResult::UPDATE_OK)
            {
                Log(".");
                if (Update.write(data, len) != len)
                    _setUpdaterError();
            }

            if (_authenticated && final && _updateResult == UpdateResult::UPDATE_OK)
            {
                if (Update.end(true))
                { // true to set the size to the current progress
                    Log("Update Success.\n");
                    _updateResult = UpdateResult::UPDATE_OK;
                    if(onUpdateEnd)
                        onUpdateEnd(_updateType, _updateResult);
                }
                else
                    _setUpdaterError();
#ifdef ESPASYNCHTTPUPDATESERVER_DEBUG
                ESPASYNCHTTPUPDATESERVER_SerialOutput.setDebugOutput(false);
#endif
            }
            else
                return;
        });
}

void ESPAsyncHTTPUpdateServer::_setUpdaterError()
{
#ifdef ESPASYNCHTTPUPDATESERVER_DEBUG
    Update.printError(ESPASYNCHTTPUPDATESERVER_SerialOutput);
#endif
    StreamString str;
    Update.printError(str);
    _updaterError = str.c_str();
    
    _updateResult = UpdateResult::UPDATE_ERROR;
    if(onUpdateEnd)
        onUpdateEnd(_updateType, _updateResult);
}